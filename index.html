<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#4f46e5',
                            dark: '#6366f1'
                        },
                        secondary: {
                            light: '#f43f5e',
                            dark: '#fb7185'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-full flex flex-col">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Connexion</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium mb-1">Mot de passe</label>
                    <input type="password" id="password" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                </div>
                <button type="submit" class="w-full bg-primary-light dark:bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden flex-1 container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold">Smart Relay Control</h1>
                <p class="text-gray-600 dark:text-gray-400">Contrôle de 8 relais via ESP32</p>
            </div>
            <div class="flex items-center space-x-4">
                
                            <div class="p-4">
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="checkbox" id="toggleTheme" class="hidden" />
                  <span class="w-10 h-6 bg-gray-300 rounded-full relative">
                    <span class="dot absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition"></span>
                  </span>
                  <span>Mode sombre</span>
                </label>
              </div>


                <button id="logoutBtn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Relay Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Relay cards will be dynamically inserted here -->
        </div>

        <!-- Scheduler Section -->
                  <!-- Formulaire ajout programme -->
          <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md max-w-md mx-auto mt-6">
            <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Ajouter un programme horaire</h3>
            <form id="scheduleForm" class="space-y-4">
              <div>
                <label for="relayNumber" class="block mb-1 text-gray-700 dark:text-gray-300">Numéro relais (1-8)</label>
                <input type="number" id="relayNumber" min="1" max="8" required class="w-full p-2 rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-200" />
              </div>
              <div>
                <label for="action" class="block mb-1 text-gray-700 dark:text-gray-300">Action</label>
                <select id="action" required class="w-full p-2 rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-200">
                  <option value="on">Allumer</option>
                  <option value="off">Éteindre</option>
                </select>
              </div>
              <div>
                <label for="time" class="block mb-1 text-gray-700 dark:text-gray-300">Heure (HH:mm)</label>
                <input type="time" id="time" required class="w-full p-2 rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-200" />
              </div>
              <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition">Ajouter</button>
            </form>
            <div id="scheduleMsg" class="mt-2 text-sm"></div>
          </div>

        <!-- Add Schedule Modal -->
        <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-6">Nouveau programme</h2>
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label for="scheduleRelay" class="block text-sm font-medium mb-1">Relais</label>
                        <select id="scheduleRelay" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                            <option value="">Sélectionner un relais</option>
                            <option value="1">Relais 1</option>
                            <option value="2">Relais 2</option>
                            <option value="3">Relais 3</option>
                            <option value="4">Relais 4</option>
                            <option value="5">Relais 5</option>
                            <option value="6">Relais 6</option>
                            <option value="7">Relais 7</option>
                            <option value="8">Relais 8</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="scheduleOnTime" class="block text-sm font-medium mb-1">Heure d'allumage</label>
                            <input type="time" id="scheduleOnTime" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                        </div>
                        <div>
                            <label for="scheduleOffTime" class="block text-sm font-medium mb-1">Heure d'extinction</label>
                            <input type="time" id="scheduleOffTime" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" id="cancelScheduleBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200">Annuler</button>
                        <button type="submit" class="bg-primary-light dark:bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
    </div>

   <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<!-- Font Awesome pour les icônes -->
<script src="https://kit.fontawesome.com/your_kit_code.js" crossorigin="anonymous"></script>
<script>
// --- Configuration Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyAJcmaVULTXVdwi0OX6TfJAaGGV3zQZGN0",
  authDomain: "fin-etude-e51b2.firebaseapp.com",
  databaseURL: "https://fin-etude-e51b2-default-rtdb.firebaseio.com",
  projectId: "fin-etude-e51b2",
  storageBucket: "fin-etude-e51b2.appspot.com",
  messagingSenderId: "266327798549",
  appId: "1:266327798549:web:f20ac04b94ab2d8a19ef1c",
  measurementId: "G-FQV4XHD101"
};

// --- Initialisation Firebase ---
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// --- Sélecteurs DOM ---
const loginForm = document.getElementById("loginForm");
const logoutBtn = document.getElementById("logoutBtn");
const authModal = document.getElementById("authModal");
const app = document.getElementById("app");
const relayGrid = document.querySelector(".grid");
const addScheduleBtn = document.getElementById("addScheduleBtn");

// --- Icônes relais ---
const relayIcons = [
  "fa-lightbulb", "fa-fan", "fa-plug", "fa-tv",
  "fa-thermometer-half", "fa-water", "fa-lock", "fa-bell"
];

// --- Surveillance de la connexion ---
auth.onAuthStateChanged(user => {
  console.log("User state changed:", user);
  if (user) {
    authModal.classList.add("hidden");
    app.classList.remove("hidden");
    startDashboard();
  } else {
    app.classList.add("hidden");
    authModal.classList.remove("hidden");
  }
});

// --- Connexion ---
loginForm.addEventListener("submit", e => {
  e.preventDefault();
  const email = loginForm["email"].value;
  const password = loginForm["password"].value;
  auth.signInWithEmailAndPassword(email, password)
    .catch(error => alert("Erreur connexion : " + error.message));
});

// --- Déconnexion ---
logoutBtn.addEventListener("click", () => auth.signOut());

// --- Démarrage de l'app ---
function startDashboard() {
  loadRelays();
  setupRelayActions();
  setupScheduleSystem();
  startUsageMonitoring();
  restoreTheme();
}

// --- Gestion toggle mode sombre/clair ---
const toggleThemeCheckbox = document.getElementById("toggleTheme");

function applyTheme(dark) {
  if (dark) {
    document.documentElement.classList.add("dark");
  } else {
    document.documentElement.classList.remove("dark");
  }
  localStorage.setItem("theme", dark ? "dark" : "light");
}

function loadTheme() {
  const stored = localStorage.getItem("theme");
  if (stored === "dark") {
    toggleThemeCheckbox.checked = true;
    applyTheme(true);
  } else if (stored === "light") {
    toggleThemeCheckbox.checked = false;
    applyTheme(false);
  } else {
    // Par défaut système
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    toggleThemeCheckbox.checked = prefersDark;
    applyTheme(prefersDark);
  }
}

toggleThemeCheckbox.addEventListener("change", () => {
  applyTheme(toggleThemeCheckbox.checked);
});

loadTheme();

// --- Gestion formulaire ajout programme ---
const scheduleForm = document.getElementById("scheduleForm");
const scheduleMsg = document.getElementById("scheduleMsg");

scheduleForm.addEventListener("submit", e => {
  e.preventDefault();

  const relay = parseInt(scheduleForm.relayNumber.value);
  const action = scheduleForm.action.value;
  const time = scheduleForm.time.value;

  if (relay < 1 || relay > 8) {
    scheduleMsg.textContent = "Le numéro du relais doit être entre 1 et 8.";
    scheduleMsg.className = "text-red-500 mt-2";
    return;
  }

  if (!/^([01]\d|2[0-3]):([0-5]\d)$/.test(time)) {
    scheduleMsg.textContent = "Heure invalide, format HH:mm attendu.";
    scheduleMsg.className = "text-red-500 mt-2";
    return;
  }

  const newSchedule = { relay, action, time };

  database.ref('schedules').push(newSchedule)
    .then(() => {
      scheduleMsg.textContent = "Programme ajouté avec succès !";
      scheduleMsg.className = "text-green-500 mt-2";
      scheduleForm.reset();
    })
    .catch(err => {
      scheduleMsg.textContent = "Erreur ajout programme : " + err.message;
      scheduleMsg.className = "text-red-500 mt-2";
    });
});


// --- Chargement des relais ---
function loadRelays() {
  database.ref("relays").on("value", snapshot => {
    const relays = snapshot.val() || {};
    renderRelays(relays);
  });
}

// --- Affichage relais ---
function renderRelays(relays) {
  relayGrid.innerHTML = "";

  for (let i = 1; i <= 8; i++) {
    const r = relays[i] || { name: `Relais ${i}`, state: false };
    const icon = relayIcons[i - 1] || "fa-bolt";

    relayGrid.innerHTML += `
      <div class="card bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
        <div class="flex justify-between mb-2">
          <h4>${r.name}</h4>
          <span class="${r.state ? 'text-green-500' : 'text-gray-400'}">${r.state ? 'ON' : 'OFF'}</span>
        </div>
        <div class="text-center text-4xl ${r.state ? 'text-yellow-400' : 'text-gray-500'}">
          <i class="fas ${icon}"></i>
        </div>
        <div class="flex justify-between mt-4">
          <button data-relay="${i}" data-action="toggle" class="btn-toggle bg-primary text-white px-4 py-2 rounded">
            <i class="fas fa-power-off"></i>
          </button>
          <button data-relay="${i}" data-action="rename" class="bg-gray-300 p-2 rounded"><i class="fas fa-edit"></i></button>
        </div>
        <div class="mt-2 text-sm text-gray-500" id="relay-${i}-duration">Durée : 00:00:00</div>
      </div>
    `;
  }
}

// --- Actions boutons relais ---
function setupRelayActions() {
  document.addEventListener("click", e => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const relay = parseInt(btn.dataset.relay);
    const action = btn.dataset.action;

    if (action === "toggle") toggleRelay(relay);
    else if (action === "rename") renameRelay(relay);
  });
}

// --- Basculer relais ---
function toggleRelay(relay) {
  const ref = database.ref("relays/" + relay);
  ref.once("value").then(snapshot => {
    const currentState = snapshot.val()?.state || false;
    ref.update({
      state: !currentState,
      changedBy: auth.currentUser?.email || "inconnu",
      lastChanged: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => console.log(`Relais ${relay} state changé à ${!currentState}`))
    .catch(err => alert("Erreur update relais : " + err.message));
  });
}

// --- Renommer relais ---
function renameRelay(relay) {
  const newName = prompt("Nouveau nom du relais ?");
  if (newName) {
    database.ref("relays/" + relay).update({ name: newName });
  }
}

// --- Monitoring durée allumage + auto-extinction ---
const relayUsage = {};

function startUsageMonitoring() {
  setInterval(() => {
    database.ref("relays").once("value", snapshot => {
      const relays = snapshot.val() || {};
      const now = Date.now();

      for (let i = 1; i <= 8; i++) {
        const relay = relays[i];
        if (!relay) continue;

        if (relay.state) {
          if (!relayUsage[i]) relayUsage[i] = now;
          const diff = now - relayUsage[i];

          if (diff > 5 * 60 * 60 * 1000) {  // 5h en ms
            database.ref(`relays/${i}`).update({ state: false });
            alert(`Relais ${i} éteint automatiquement après 5h.`);
            relayUsage[i] = null;
          }

          const seconds = Math.floor(diff / 1000);
          const el = document.getElementById(`relay-${i}-duration`);
          if(el) el.textContent = "Durée : " + formatDuration(seconds);
        } else {
          relayUsage[i] = null;
          const el = document.getElementById(`relay-${i}-duration`);
          if(el) el.textContent = "Durée : 00:00:00";
        }
      }
    });
  }, 1000);
}

function formatDuration(seconds) {
  const h = String(Math.floor(seconds / 3600)).padStart(2, "0");
  const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
  const s = String(seconds % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

// --- Gestion des programmes horaires ---
function setupScheduleSystem() {
  if (!addScheduleBtn) return;

  addScheduleBtn.addEventListener('click', () => {
    const time = prompt("Heure au format HH:mm (ex: 19:00) ?");
    const relay = parseInt(prompt("Numéro du relais (1-8) ?"));
    const action = prompt("Action ('on' ou 'off') ?").toLowerCase();

    if (!time || !relay || !['on','off'].includes(action)) {
      alert("Données invalides !");
      return;
    }

    const newSchedule = { time, relay, action };

    database.ref('schedules').push(newSchedule)
      .then(() => alert("Programme ajouté !"))
      .catch(err => alert("Erreur ajout programme : " + err.message));
  });
}


</script>

</body>
</html>
